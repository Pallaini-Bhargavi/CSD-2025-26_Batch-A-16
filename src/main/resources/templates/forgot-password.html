<!DOCTYPE html>
<html>
<head>
    <title>Reset Password</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<button class="back-btn" onclick="location.href='/login'">‚Üê Back</button>

<div class="page-header">
    <div class="project-title">
        üîê Secure Data Hiding using Calendar Heatmap Steganography
    </div>
    <div class="page-subtitle">Reset Password</div>
</div>

<div class="container">
    <div class="card">

        <!-- EMAIL -->
        <label>Email <span style="color:red">*</span></label>
        <input type="email"
               id="fpEmail"
               placeholder="Enter registered email"
               oninput="loadSecurityQuestion()">

        <!-- NEW PASSWORD -->
        <label>New Password <span style="color:red">*</span></label>
        <input type="password"
               id="newPassword"
               placeholder="Enter new password">

        <!-- CONFIRM PASSWORD -->
        <label>Confirm Password</label>
        <input type="password"
               id="confirmPassword"
               placeholder="Re-enter new password">

        <!-- SECURITY QUESTION -->
        <label class="required">Security Question</label>
        <input type="text"
               id="securityQuestion"
               readonly
               placeholder="Security question will load automatically">

        <!-- ANSWER -->
        <label>Answer <span style="color:red">*</span></label>
        <textarea id="answer"
                  placeholder="Enter your answer"></textarea>

        <button class="btn blue" onclick="resetPassword()">
            Change Password
        </button>

    </div>
</div>

<!-- ERROR POPUP -->
<div id="errorPopup" style="
display:none; position:fixed; inset:0;
background:rgba(0,0,0,0.7); z-index:999;
align-items:center; justify-content:center;">

    <div style="
    background:#fff; color:#dc2626;
    padding:22px; border-radius:16px;
    width:360px; text-align:center;
    font-weight:600; position:relative;">

        <span onclick="closeError()"
              style="position:absolute; top:10px; right:14px;
              cursor:pointer; font-size:18px;">‚úñ</span>

        <div id="errorMsg"></div>
    </div>
</div>

<!-- SUCCESS POPUP -->
<div id="successPopup" style="
display:none; position:fixed; inset:0;
background:rgba(0,0,0,0.7); z-index:999;
align-items:center; justify-content:center;">

    <div style="
    background:#fff; color:#16a34a;
    padding:22px; border-radius:16px;
    width:360px; text-align:center;
    font-weight:600; position:relative;">

        <span onclick="closeSuccess()"
              style="position:absolute; top:10px; right:14px;
              cursor:pointer; font-size:18px;">‚úñ</span>

        <div id="successMsg"></div>
    </div>
</div>

<script>
/* ---------------- POPUPS ---------------- */

function showError(msg) {
    document.getElementById("errorMsg").innerText = msg;
    document.getElementById("errorPopup").style.display = "flex";
}

function closeError() {
    document.getElementById("errorPopup").style.display = "none";
}

function showSuccess(msg) {
    document.getElementById("successMsg").innerText = msg;
    document.getElementById("successPopup").style.display = "flex";
    setTimeout(closeSuccess, 2500);
}

function closeSuccess() {
    document.getElementById("successPopup").style.display = "none";
}

/* ---------------- LOAD SECURITY QUESTION ---------------- */

function loadSecurityQuestion() {

    const email =
        document.getElementById("fpEmail")
        .value.trim().toLowerCase();

    const questionField =
        document.getElementById("securityQuestion");

    // Reset while typing
    questionField.value = "";

    if (!email || !email.includes("@")) {
        return;
    }

    fetch(`/api/security-question?email=${encodeURIComponent(email)}`)
        .then(res => {
            if (res.status === 404) {
                throw "User not found";
            }
            if (!res.ok) {
                throw "Invalid email";
            }
            return res.text();
        })
        .then(question => {
            questionField.value = question;
        })
        .catch(msg => {
            questionField.value = msg;
        });
}

/* ---------------- RESET PASSWORD ---------------- */

function resetPassword() {

    const email =
        document.getElementById("fpEmail").value.trim();
    const newPwd =
        document.getElementById("newPassword").value.trim();
    const confirmPwd =
        document.getElementById("confirmPassword").value.trim();
    const answer =
        document.getElementById("answer").value.trim();

    if (!email) return showError("Email is required.");
    if (!newPwd) return showError("New password is required.");
    if (!confirmPwd) return showError("Confirm password is required.");
    if (newPwd !== confirmPwd)
        return showError("Passwords do not match.");
    if (!answer) return showError("Security answer is required.");

    fetch("/api/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            email: email,
            newPassword: newPwd,
            answer: answer
        })
    })
    .then(res =>
        res.text().then(text => {
            if (!res.ok) throw text;
            showSuccess(text);
        })
    )
    .catch(err => showError(err));
}
</script>

</body>
</html>
