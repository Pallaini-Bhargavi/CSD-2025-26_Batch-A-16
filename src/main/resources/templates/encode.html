<!DOCTYPE html>
<html>
<head>
    <title>Secure Data Hiding using Calendar Heatmap steganography</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
/* ===== ACCOUNT DROPDOWN ===== */
.account-wrapper {
    position: fixed;
    top: 48px;              
    z-index: 1000;
}

.account-wrapper.right {
    right: 32px;           
}


.account-icon {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: rgba(255,255,255,0.12);
    color: #ffff;
    font-size: 26px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

.account-dropdown {
    display: none;
    position: absolute;
    left: auto;
    right:0;
    margin-top: 14px;
    background: #ffffff;
    color: #111;
    border-radius: 16px;
    width: 280px;
    box-shadow: 0 16px 32px rgba(0,0,0,0.25);
    overflow: hidden;
    transition: all 0.2s ease;
}

.account-dropdown .item {
    padding: 18px 20px;
    font-size: 16px;
    border-bottom: 1px solid #e5e7eb;
}

.account-dropdown .item.email {
    font-weight: 600;
    color: #2563eb;
    word-break: break-all;
}

.account-dropdown .item.logout {
    cursor: pointer;
    color: #dc2626;
    font-weight: 600;
}

.account-dropdown .item.logout:hover {
    background: #fee2e2;
}
</style>

</head>
<body>
<!-- ===== ACCOUNT DROPDOWN  ===== -->
<div class="account-wrapper right">
    <div class="account-icon" onclick="toggleAccountDropdown()">
        <span>
            <!-- first letter of email -->
            <span th:text="${#strings.substring(session.USER_EMAIL,0,1).toUpperCase()}">U</span>
        </span>
    </div>

    <div id="accountDropdown" class="account-dropdown">
        <div class="item email"
             th:text="${session.USER_EMAIL}">
            user@email.com
        </div>

        <div class="item logout" onclick="logoutUser()">
            Logout
        </div>
    </div>
</div>

<button class="back-btn" onclick="location.href='/home'">‚Üê Back</button>

<div class="page-header">
    <div class="project-title">üîê Secure Data Hiding using Calendar Heatmap steganography</div>
    <div class="page-subtitle">Encode Message</div>
</div>

<div class="container">
    <div class="card" style="margin-top:60px;">

        <label>Receiver Email</label>
        <input type="email" id="recvEmail" placeholder="Enter receiver email">

        <label>Plaintext Message</label>
        <textarea id="plainText"
                  rows="5"
                  maxlength="2000"
                  placeholder="Enter text"
                  oninput="updateMainCount()"></textarea>

        <!-- COUNT + CLEAR (MAIN AREA) -->
        <div style="
            display:flex;
            justify-content:space-between;
            font-size:12px;
            margin-top:6px;
            color:#aaa;
        ">
            <span id="mainCharCount">0/2000</span>
            <span style="cursor:pointer;color:#26c1dc;"
                  onclick="clearMainText()">Clear</span>
        </div>

        <button class="btn" onclick="generateHeatmap()">Generate Heatmap</button>

    </div>
</div>

<!-- ================= ERROR POPUP ================= -->
<div id="errorPopup" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    z-index:999;
    align-items:center;
    justify-content:center;
">
    <div style="
        background:#fff;
        color:#dc2626;
        padding:22px;
        border-radius:16px;
        width:360px;
        text-align:center;
        font-weight:600;
        position:relative;
    ">
        <span onclick="closeError()" style="
            position:absolute;
            top:10px;
            right:14px;
            cursor:pointer;
        ">‚úñ</span>
        <div id="errorMsg"></div>
    </div>
</div>

<!-- ================= SUCCESS POPUP ================= -->
<div id="successPopup" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    z-index:999;
    align-items:center;
    justify-content:center;
">
    <div style="
        background:#ffffff;
        color:#16a34a;
        padding:22px;
        border-radius:16px;
        width:360px;
        text-align:center;
        font-weight:600;
        position:relative;
    ">
        <span onclick="closeSuccess()" style="
            position:absolute;
            top:10px;
            right:14px;
            cursor:pointer;
            font-size:18px;
            font-weight:700;
        ">‚úñ</span>
        <div>Heatmap sent successfully.</div>
    </div>
</div>

<!-- ================= PREVIEW POPUP ================= -->
<div id="previewModal" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    z-index:999;
    align-items:center;
    justify-content:center;
">
    <div style="
        background:#ffffff;
        padding:20px;
        border-radius:16px;
        width:380px;
        text-align:center;
        position:relative;
    ">

        <span onclick="closePreview()" style="
            position:absolute;
            top:10px;
            right:14px;
            cursor:pointer;
            font-size:18px;
            font-weight:700;
            color: black;
        ">‚úñ</span>

        <h3 style="margin-bottom:10px; color: blue;">Heatmap Preview</h3>

        <img id="previewImage"
             style="width:100%;border-radius:12px;margin-bottom:16px;display:none;">

        <button class="btn blue" onclick="sendHeatmap()">Send</button>
    </div>
</div>

<script>
const MAX_LEN = 2000;

function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

/* ---------- MAIN TEXTAREA COUNT ---------- */
function updateMainCount() {
    const txt = document.getElementById("plainText");

    if (txt.value.length > MAX_LEN) {
        txt.value = txt.value.substring(0, MAX_LEN);
        showError("Character limit exceeded (2000).");
    }

    document.getElementById("mainCharCount").innerText =
        txt.value.length + "/2000";
}

function clearMainText() {
    document.getElementById("plainText").value = "";
    updateMainCount();
}

/* ---------- POPUPS ---------- */
function showError(msg) {
    document.getElementById("errorMsg").innerText = msg;
    document.getElementById("errorPopup").style.display = "flex";
}

function closeError() {
    document.getElementById("errorPopup").style.display = "none";
}

function showSuccess() {
    document.getElementById("successPopup").style.display = "flex";
}

function closeSuccess() {
    document.getElementById("successPopup").style.display = "none";
}

function closePreview() {
    document.getElementById("previewModal").style.display = "none";
}

/* ---------- ACTIONS ---------- */
function sendHeatmap() {

    fetch("/api/encode/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            receiverEmail: document.getElementById("recvEmail").value
        })
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(msg => { throw msg; });
        }
        document.getElementById("previewModal").style.display = "none";
        showSuccess();
    })
    .catch(err => {
        showError(err);
    });
}

function toggleAccountDropdown() {
    const dd = document.getElementById("accountDropdown");
    dd.style.display = dd.style.display === "block" ? "none" : "block";
}

// close when clicking outside
document.addEventListener("click", function (e) {
    const wrapper = document.querySelector(".account-wrapper");
    if (!wrapper.contains(e.target)) {
        document.getElementById("accountDropdown").style.display = "none";
    }
});

function logoutUser() {
    window.location.href = "/logout";
}

function generateHeatmap() {

    const email = document.getElementById("recvEmail").value.trim();
    const msg   = document.getElementById("plainText").value.trim();

    if (!email) {
        showError("Receiver email is required.");
        return;
    }

    if (!isValidEmail(email)) {
        showError("Please enter a valid email address.");
        return;
    }

    if (!msg) {
        showError("Text cannot be empty.");
        return;
    }

    fetch("/api/encode/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            receiverEmail: email,
            plaintext: msg
        })
    })
    .then(res => {
        if (res.status === 401) {
            throw "Session expired. Please login again.";
        }
        if (!res.ok) {
            return res.text().then(msg => { throw msg; });
        }
        return res.blob();
    })
    .then(blob => {
        const url = URL.createObjectURL(blob);

        const img = document.getElementById("previewImage");
        img.src = url;
        img.style.display = "block";

        document.getElementById("previewModal").style.display = "flex";
    })
    .catch(err => {
        showError(err);
    });
}
</script>

</body>
</html>
